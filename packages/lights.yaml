mqtt:
  # Lights
  light:
    # Kitchen Switch
    - unique_id: "mqtt.light.night"
      name: "Night"
      state_topic: "stat/kitchen/POWER1"
      command_topic: "cmnd/kitchen/POWER1"
      availability_topic: "tele/kitchen/LWT"
      qos: 1
      payload_on: "ON"
      payload_off: "OFF"
      payload_available: "Online"
      payload_not_available: "Offline"
      retain: false
    - unique_id: "mqtt.light.dining-room"
      name: "Dining Room"
      state_topic: "stat/kitchen/POWER2"
      command_topic: "cmnd/kitchen/POWER2"
      availability_topic: "tele/kitchen/LWT"
      qos: 1
      payload_on: "ON"
      payload_off: "OFF"
      payload_available: "Online"
      payload_not_available: "Offline"
      retain: false
    - unique_id: "mqtt.light.kitchen"
      name: "Kitchen"
      state_topic: "stat/kitchen/POWER3"
      command_topic: "cmnd/kitchen/POWER3"
      availability_topic: "tele/kitchen/LWT"
      qos: 1
      payload_on: "ON"
      payload_off: "OFF"
      payload_available: "Online"
      payload_not_available: "Offline"
      retain: false

    # Bar Switch
    - unique_id: "mqtt.light.bar"
      name: "Bar"
      state_topic: "stat/bar/POWER1"
      command_topic: "cmnd/bar/POWER1"
      availability_topic: "tele/bar/LWT"
      qos: 1
      payload_on: "ON"
      payload_off: "OFF"
      payload_available: "Online"
      payload_not_available: "Offline"
      retain: false
    - unique_id: "mqtt.light.veranda"
      name: "Veranda"
      state_topic: "stat/bar/POWER2"
      command_topic: "cmnd/bar/POWER2"
      availability_topic: "tele/bar/LWT"
      qos: 1
      payload_on: "ON"
      payload_off: "OFF"
      payload_available: "Online"
      payload_not_available: "Offline"
      retain: false
    # Bar Lamp
    - unique_id: "mqtt.light.bar-lamp"
      name: "Bar Lamp"
      state_topic: "stat/bar-lamp/POWER"
      command_topic: "cmnd/bar-lamp/POWER"
      availability_topic: "tele/bar-lamp/LWT"
      qos: 1
      payload_on: "ON"
      payload_off: "OFF"
      payload_available: "Online"
      payload_not_available: "Offline"
      retain: false

    # Lounge Switch
    - unique_id: "mqtt.light.lounge-main"
      name: "Lounge Main"
      state_topic: "stat/lounge/POWER"
      command_topic: "cmnd/lounge/POWER"
      availability_topic: "tele/lounge/LWT"
      qos: 1
      payload_on: "ON"
      payload_off: "OFF"
      payload_available: "Online"
      payload_not_available: "Offline"
      retain: false
    # Lounge Lamp 1
    - unique_id: "mqtt.light.lounge-lamp-1"
      name: "Lounge Lamp 1"
      state_topic: "stat/lounge-lamp-1/POWER"
      command_topic: "cmnd/lounge-lamp-1/POWER"
      availability_topic: "tele/lounge-lamp-1/LWT"
      qos: 1
      payload_on: "ON"
      payload_off: "OFF"
      payload_available: "Online"
      payload_not_available: "Offline"
      retain: false
    # Lounge Lamp 2
    - unique_id: "mqtt.light.lounge-lamp-2"
      name: "Lounge Lamp 2"
      state_topic: "stat/lounge-lamp-2/POWER"
      command_topic: "cmnd/lounge-lamp-2/POWER"
      availability_topic: "tele/lounge-lamp-2/LWT"
      qos: 1
      payload_on: "ON"
      payload_off: "OFF"
      payload_available: "Online"
      payload_not_available: "Offline"
      retain: false

    # Outside Switch
    - unique_id: "mqtt.light.outside"
      name: "Outside"
      state_topic: "stat/outside/POWER"
      command_topic: "cmnd/outside/POWER"
      availability_topic: "tele/outside/LWT"
      qos: 1
      payload_on: "ON"
      payload_off: "OFF"
      payload_available: "Online"
      payload_not_available: "Offline"
      retain: false

    # Study Switch
    - unique_id: "mqtt.light.study"
      name: "Study"
      state_topic: "stat/study/POWER"
      command_topic: "cmnd/study/POWER"
      availability_topic: "tele/study/LWT"
      qos: 1
      payload_on: "ON"
      payload_off: "OFF"
      payload_available: "Online"
      payload_not_available: "Offline"
      retain: false

    # Bedroom Switch
    - unique_id: "mqtt.light.bedroom"
      name: "Bedroom"
      state_topic: "stat/bedroom/POWER1"
      command_topic: "cmnd/bedroom/POWER1"
      availability_topic: "tele/bedroom/LWT"
      qos: 1
      payload_on: "ON"
      payload_off: "OFF"
      payload_available: "Online"
      payload_not_available: "Offline"
      retain: false
    - unique_id: "mqtt.light.ensuite"
      name: "Ensuite"
      state_topic: "stat/bedroom/POWER2"
      command_topic: "cmnd/bedroom/POWER2"
      availability_topic: "tele/bedroom/LWT"
      qos: 1
      payload_on: "ON"
      payload_off: "OFF"
      payload_available: "Online"
      payload_not_available: "Offline"
      retain: false

    # Entrance Switch
    - unique_id: "mqtt.light.entrance"
      name: "Entrance"
      state_topic: "stat/entrance/POWER"
      command_topic: "cmnd/entrance/POWER"
      availability_topic: "tele/entrance/LWT"
      qos: 1
      payload_on: "ON"
      payload_off: "OFF"
      payload_available: "Online"
      payload_not_available: "Offline"
      retain: false

    # Hallway Switch
    - unique_id: "mqtt.light.hallway"
      name: "Hallway"
      state_topic: "stat/hallway/POWER"
      command_topic: "cmnd/hallway/POWER"
      availability_topic: "tele/hallway/LWT"
      qos: 1
      payload_on: "ON"
      payload_off: "OFF"
      payload_available: "Online"
      payload_not_available: "Offline"
      retain: false

    # Breezeway Switch
    - unique_id: "mqtt.light.breezeway"
      name: "Breezeway"
      state_topic: "stat/breezeway/POWER"
      command_topic: "cmnd/breezeway/POWER"
      availability_topic: "tele/breezeway/LWT"
      qos: 1
      payload_on: "ON"
      payload_off: "OFF"
      payload_available: "Online"
      payload_not_available: "Offline"
      retain: false

    # Bathroom Switch
    - unique_id: "mqtt.light.bathroom"
      name: "Bathroom"
      state_topic: "stat/bathroom/POWER"
      command_topic: "cmnd/bathroom/POWER"
      availability_topic: "tele/bathroom/LWT"
      qos: 1
      payload_on: "ON"
      payload_off: "OFF"
      payload_available: "Online"
      payload_not_available: "Offline"
      retain: false

    # Toilet Switch
    - unique_id: "mqtt.light.toilet"
      name: "Toilet"
      state_topic: "stat/toilet/POWER"
      command_topic: "cmnd/toilet/POWER"
      availability_topic: "tele/toilet/LWT"
      qos: 1
      payload_on: "ON"
      payload_off: "OFF"
      payload_available: "Online"
      payload_not_available: "Offline"
      retain: false

    # Driveway Switch
    - unique_id: "mqtt.light.driveway"
      name: "Driveway"
      state_topic: "stat/driveway/POWER"
      command_topic: "cmnd/driveway/POWER"
      availability_topic: "tele/driveway/LWT"
      qos: 1
      payload_on: "ON"
      payload_off: "OFF"
      payload_available: "Online"
      payload_not_available: "Offline"
      retain: false

# Groups ===================================

light:
  # Bar Lights
  - platform: group
    unique_id: "group.light.bar"
    name: "Bar Lights"
    entities:
      - light.bar_lamp
      - light.bar
  # Lounge Lamps
  - platform: group
    unique_id: "mqtt.light.lounge-lamps"
    name: "Lounge Lamps"
    entities:
      - light.lounge_lamp_1
      - light.lounge_lamp_2

# Automation ===============================

automation:
  - alias: Sync Tasmota states
    initial_state: true
    trigger:
      platform: homeassistant
      event: start
    action:
      service: mqtt.publish
      data:
        topic: cmnd/tasmotas/POWER0
        payload: ''
  - alias: Lounge Lamps Toggle
    trigger:
        platform: mqtt
        topic: "cmnd/lounge-lamps/POWER"
        payload: 'TOGGLE'
    action:
        service: light.toggle
        entity_id: light.lounge_lamps
  - alias: Bar Lamps Toggle
    trigger:
        platform: mqtt
        topic: "cmnd/bar-lamps/POWER"
        payload: 'TOGGLE'
    action:
        service: light.toggle
        entity_id: light.bar_lights

  - alias: Arrival Mode
    trigger:
      - platform: state
        entity_id: group.everyone
        from: "not_home"
        to: "home"
    condition:
      - condition: state  # from sunset until sunrise
        entity_id: sun.sun
        state: "below_horizon"
    action:
        service: light.turn_on
        entity_id: light.entrance

  - alias: Away Mode
    trigger:
        platform: state
        entity_id: group.everyone
        from: "home"
        to: "not_home"
        for:
          minutes: 5
    action:
        service: light.turn_off
        data_template:
            entity_id: >-
                {% set state = 'on' %}
                {% set filter = ['light.driveway'] %}
                {% set names = states.light
                | selectattr('state','eq', state)
                | rejectattr('entity_id','in', filter)
                | map(attribute = 'entity_id')
                | join(',')
                %}
                {% if names.count('.') >= 1 %}
                {{ names }}
                {% else %}
                light.dummy
                {% endif %}
